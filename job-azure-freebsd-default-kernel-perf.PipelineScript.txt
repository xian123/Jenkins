def FIO_1Disk = FIO_1Disk
def FIO_12Disks = FIO_12Disks

def SIO_1Disk = SIO_1Disk
def SIO_12Disks = SIO_12Disks

def KQ_Perf = KQ_Perf

def SpecifiedFreebsdARMImage = "${env.SpecifiedFreebsdARMImage}"
def location = "${env.location}"
def SecretsFilePath = "C:/DoNotDelete/secretsFile.xml"
def AllFreebsdARMImages = ['MicrosoftOSTC FreeBSD 11.1 latest', 
					   'MicrosoftOSTC FreeBSD 11.0 latest', 
					   'MicrosoftOSTC FreeBSD 10.4 latest', 
					   'MicrosoftOSTC FreeBSD 10.3 latest']


					   
					   
def RunPowershellCommand(psCmd) {
    bat "powershell.exe -NonInteractive -ExecutionPolicy Bypass -Command \"[Console]::OutputEncoding=[System.Text.Encoding]::UTF8;$psCmd;EXIT \$global:LastExitCode\""
    // println "${psCmd}"
}


pipeline
{

    parameters {
		booleanParam(defaultValue: false, description: 'Fio single disk test.', name: 'FIO_1Disk')
		booleanParam(defaultValue: true, description: 'Fio x12 disks (RAID0) test.', name: 'FIO_12Disks')
		booleanParam(defaultValue: false, description: 'Sio single disk test.', name: 'SIO_1Disk')
		booleanParam(defaultValue: false, description: 'Sio x12 disks (RAID0) test.', name: 'SIO_12Disks')
		booleanParam(defaultValue: false, description: 'KQ perf test.', name: 'KQ_Perf')
		choice(choices: 'MicrosoftOSTC FreeBSD 11.1 latest\nMicrosoftOSTC FreeBSD 11.0 latest\nMicrosoftOSTC FreeBSD 10.4 latest\nMicrosoftOSTC FreeBSD 10.3 latest\nALL', description: 'It is a specified freebsd image. All latest images (10.3, 10.4, 11.0 and 11.1) will be tested if it is ALL.', name: 'SpecifiedFreebsdARMImage')
		choice(choices: 'disabled\nenabled\nboth', description: 'Provide SRIOV state for tests: enabled, disabled or both.', name: 'sriov')
		choice(choices: 'eastus2\naustraliaeast\nsoutheastasia\nwestcentralus\neastus', description: 'Data center location.', name: 'location')
    }

    agent {
        node {
          label 'azurebsd'
        }
    }
	
   	
	stages{	
	
		stage('FIO_1Disk dependencies') {
            when {
                expression { env.FIO_1Disk.contains('true') }
            }
			
			steps 
            {
				script {
					try{
						if( SpecifiedFreebsdARMImage && SpecifiedFreebsdARMImage!='ALL')
						{
							println "The test is only for the specified image: ${SpecifiedFreebsdARMImage}"
							git poll: false, changelog: false, url: 'https://github.com/xian123/azure-linux-automation', branch: 'test'
                            $cmd =  ".\\RunAzureTests.ps1"
                            $cmd += " -testLocation '${location}'"
                            $cmd += " -DistroIdentifier 'bsdfiosingledisk'"
                            $cmd += " -testCycle 'PERF-FIO-SingleDisk'"
                            $cmd += " -ARMImageName '${SpecifiedFreebsdARMImage}'"
                            $cmd += " -StorageAccount 'ExistingStorage_Premium'"
                            $cmd += " -customSecretsFilePath '${SecretsFilePath}'"
                            $cmd += " -ResultDBTable 'Perf_FreeBSD_Marketplace_Azure_Fio'"

							RunPowershellCommand($cmd)
						}
						else
						{						
							git poll: false, changelog: false, url: 'https://github.com/xian123/azure-linux-automation', branch: 'test'
							for (int i = 0; i < AllFreebsdARMImages.size(); i++) {
								println "The current test image: ${AllFreebsdARMImages[i]}"
                                $cmd =  ".\\RunAzureTests.ps1"
                                $cmd += " -testLocation '${location}'"
                                $cmd += " -DistroIdentifier 'bsdfiosingledisk'"
                                $cmd += " -testCycle 'PERF-FIO-SingleDisk'"
                                $cmd += " -ARMImageName '${AllFreebsdARMImages[i]}'"
                                $cmd += " -StorageAccount 'ExistingStorage_Premium'"
                                $cmd += " -customSecretsFilePath '${SecretsFilePath}'"
                                $cmd += " -ResultDBTable 'Perf_FreeBSD_Marketplace_Azure_Fio'"

								RunPowershellCommand($cmd)
							}
						}						
					}
					catch (exc)
					{
						currentBuild.result = 'FAILURE'
						println "STAGE_FAILED_EXCEPTION."
					}

				}
			}
		
		}
		
		stage('FIO_12Disks dependencies') {
            when {
                expression { env.FIO_12Disks.contains('true') }
            }
			
			steps 
            {
				script {
					try{
						if( SpecifiedFreebsdARMImage && SpecifiedFreebsdARMImage!='ALL' )
						{
							println "The test is only for the specified image: ${SpecifiedFreebsdARMImage}"
							git poll: false, changelog: false, url: 'https://github.com/xian123/azure-linux-automation', branch: 'test'
                            $cmd =  ".\\RunAzureTests.ps1"
                            $cmd += " -testLocation '${location}'"
                            $cmd += " -DistroIdentifier 'bsdfioraid0'"
                            $cmd += " -testCycle 'PERF-FIO-RAID0'"
                            $cmd += " -ARMImageName '${SpecifiedFreebsdARMImage}'"
                            $cmd += " -StorageAccount 'ExistingStorage_Premium'"
                            $cmd += " -customSecretsFilePath '${SecretsFilePath}'"
                            $cmd += " -ResultDBTable 'Perf_FreeBSD_Marketplace_Azure_Fio'"

							RunPowershellCommand($cmd)
						}
						else
						{						
							git poll: false, changelog: false, url: 'https://github.com/xian123/azure-linux-automation', branch: 'test'
							for (int i = 0; i < AllFreebsdARMImages.size(); i++) {
								println "The current test image: ${AllFreebsdARMImages[i]}"
                                $cmd =  ".\\RunAzureTests.ps1"
                                $cmd += " -testLocation '${location}'"
                                $cmd += " -DistroIdentifier 'bsdfioraid0'"
                                $cmd += " -testCycle 'PERF-FIO-RAID0'"
                                $cmd += " -ARMImageName '${AllFreebsdARMImages[i]}'"
                                $cmd += " -StorageAccount 'ExistingStorage_Premium'"
                                $cmd += " -customSecretsFilePath '${SecretsFilePath}'"
                                $cmd += " -ResultDBTable 'Perf_FreeBSD_Marketplace_Azure_Fio'"

								RunPowershellCommand($cmd)
							}
						}						
					}
					catch (exc)
					{
						currentBuild.result = 'FAILURE'
						println "STAGE_FAILED_EXCEPTION."
					}

				}
			}
		
		}
		
		stage('SIO_1Disk dependencies') {
            when {
                expression { env.SIO_1Disk.contains('true') }
            }
			
			steps 
            {
				script {
					try{
						if( SpecifiedFreebsdARMImage && SpecifiedFreebsdARMImage!='ALL' )
						{
							println "The test is only for the specified image: ${SpecifiedFreebsdARMImage}"
							git poll: false, changelog: false, url: 'https://github.com/xian123/azure-linux-automation', branch: 'test'
                            $cmd =  ".\\RunAzureTests.ps1"
                            $cmd += " -testLocation '${location}'"
                            $cmd += " -DistroIdentifier 'bsdSiosingledisk'"
                            $cmd += " -testCycle 'PERF-SIO-SingleDisk'"
                            $cmd += " -ARMImageName '${SpecifiedFreebsdARMImage}'"
                            $cmd += " -StorageAccount 'ExistingStorage_Premium'"
                            $cmd += " -customSecretsFilePath '${SecretsFilePath}'"
                            $cmd += " -ResultDBTable 'Perf_FreeBSD_Marketplace_Azure_Sio'"

							RunPowershellCommand($cmd)
						}
						else
						{						
							git poll: false, changelog: false, url: 'https://github.com/xian123/azure-linux-automation', branch: 'test'
							for (int i = 0; i < AllFreebsdARMImages.size(); i++) {
								println "The current test image: ${AllFreebsdARMImages[i]}"
                                $cmd =  ".\\RunAzureTests.ps1"
                                $cmd += " -testLocation '${location}'"
                                $cmd += " -DistroIdentifier 'bsdSiosingledisk'"
                                $cmd += " -testCycle 'PERF-SIO-SingleDisk'"
                                $cmd += " -ARMImageName '${AllFreebsdARMImages[i]}'"
                                $cmd += " -StorageAccount 'ExistingStorage_Premium'"
                                $cmd += " -customSecretsFilePath '${SecretsFilePath}'"
                                $cmd += " -ResultDBTable 'Perf_FreeBSD_Marketplace_Azure_Sio'"

                                RunPowershellCommand($cmd)								
							}
						}					
					}
					catch (exc)
					{
						currentBuild.result = 'FAILURE'
						println "STAGE_FAILED_EXCEPTION."
					}

				}
			}
		
		}
		
		stage('SIO_12Disks dependencies') {
            when {
                expression { env.SIO_12Disks.contains('true') }
            }
			
			steps 
            {
				script {
					try{
						if( SpecifiedFreebsdARMImage && SpecifiedFreebsdARMImage!='ALL' )
						{
							println "The test is only for the specified image: ${SpecifiedFreebsdARMImage}"
							git poll: false, changelog: false, url: 'https://github.com/xian123/azure-linux-automation', branch: 'test'
                            $cmd =  ".\\RunAzureTests.ps1"
                            $cmd += " -testLocation '${location}'"
                            $cmd += " -DistroIdentifier 'bsdsioraid0'"
                            $cmd += " -testCycle 'PERF-SIO-RAID0'"
                            $cmd += " -ARMImageName '${SpecifiedFreebsdARMImage}'"
                            $cmd += " -StorageAccount 'ExistingStorage_Premium'"
                            $cmd += " -customSecretsFilePath '${SecretsFilePath}'"
                            $cmd += " -ResultDBTable 'Perf_FreeBSD_Marketplace_Azure_Sio'"

							RunPowershellCommand($cmd)
						}
						else
						{						
							git poll: false, changelog: false, url: 'https://github.com/xian123/azure-linux-automation', branch: 'test'
							for (int i = 0; i < AllFreebsdARMImages.size(); i++) {
								println "The current test image: ${AllFreebsdARMImages[i]}"
							    $cmd =  ".\\RunAzureTests.ps1"
                                $cmd += " -testLocation '${location}'"
                                $cmd += " -DistroIdentifier 'bsdsioraid0'"
                                $cmd += " -testCycle 'PERF-SIO-RAID0'"
                                $cmd += " -ARMImageName '${AllFreebsdARMImages[i]}'"
                                $cmd += " -StorageAccount 'ExistingStorage_Premium'"
                                $cmd += " -customSecretsFilePath '${SecretsFilePath}'"
                                $cmd += " -ResultDBTable 'Perf_FreeBSD_Marketplace_Azure_Sio'"

                                RunPowershellCommand($cmd)
							}
						}	
				
					}
					catch (exc)
					{
						currentBuild.result = 'FAILURE'
						println "STAGE_FAILED_EXCEPTION."
					}

				}
			}
		
		}
		
		
		stage('KQ_Perf dependencies') {
            when {
                expression { env.KQ_Perf.contains('true') }
            }
			
			steps 
            {
				script {
					try{
					    List<String>networkGroups = new ArrayList<String>()
					    if( env.sriov.contains('disabled')  ) 
					    {
							networkGroups.add('Synthetic')
					    }
					   
					    if( env.sriov.contains('enabled')  ) 
					    {
							networkGroups.add('Sriov')
					    }
					   
					    if( env.sriov.contains('both')  ) 
						{
							networkGroups.add('Synthetic')
							networkGroups.add('Sriov')
					    }
						
						if( SpecifiedFreebsdARMImage && SpecifiedFreebsdARMImage!='ALL' )
						{
							println "The test is only for the specified image: ${SpecifiedFreebsdARMImage}"
							git poll: false, changelog: false, url: 'https://github.com/xian123/azure-linux-automation', branch: 'test'

							for (int i = 0; i < networkGroups.size(); i++) {
								$cmd =  ".\\RunAzureTests.ps1"
								$cmd += " -testLocation '${location}'"
								$cmd += " -DistroIdentifier 'bsdkqperf'"
								$cmd += " -testCycle 'PERF-KQ'"
								$cmd += " -ARMImageName '${SpecifiedFreebsdARMImage}'"
								$cmd += " -StorageAccount 'ExistingStorage_Standard'"
								$cmd += " -customSecretsFilePath '${SecretsFilePath}'"
								$cmd += " -ResultDBTable 'Perf_FreeBSD_Marketplace_Azure_KQ'"
								
								if(networkGroups[i] == 'Sriov' )
								{
									$cmd += " -EnableAcceleratedNetworking"
								}

								RunPowershellCommand($cmd)
							}
						}
						else
						{						
							git poll: false, changelog: false, url: 'https://github.com/xian123/azure-linux-automation', branch: 'test'
							for (int j = 0; j < networkGroups.size(); j++) {
								for (int i = 0; i < AllFreebsdARMImages.size(); i++) {
									println "The current test image: ${AllFreebsdARMImages[i]}"
									$cmd =  ".\\RunAzureTests.ps1"
									$cmd += " -testLocation '${location}'"
									$cmd += " -DistroIdentifier 'bsdkqperf'"
									$cmd += " -testCycle 'PERF-KQ'"
									$cmd += " -ARMImageName '${AllFreebsdARMImages[i]}'"
									$cmd += " -StorageAccount 'ExistingStorage_Standard'"
									$cmd += " -customSecretsFilePath '${SecretsFilePath}'"
									$cmd += " -ResultDBTable 'Perf_FreeBSD_Marketplace_Azure_KQ'"
									if(networkGroups[j] == 'Sriov' )
									{
										$cmd += " -EnableAcceleratedNetworking"
									}
									
									RunPowershellCommand($cmd)
								}
							}
						}	
					}
					catch (exc)
					{
						currentBuild.result = 'FAILURE'
						println "STAGE_FAILED_EXCEPTION."
					}

				}
			}
		
		}
	}

	//Post #TODO
  
}
